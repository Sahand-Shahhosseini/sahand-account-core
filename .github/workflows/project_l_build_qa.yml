name: Project-L Build + QA

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install TeX + deps (LuaLaTeX + RTL)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            latexmk \
            texlive-luatex \
            texlive-latex-base texlive-latex-recommended texlive-latex-extra \
            texlive-fonts-recommended texlive-fonts-extra \
            texlive-lang-arabic texlive-lang-other \
            fonts-dejavu fonts-noto-core fonts-noto-extra \
            python3 \
            zip unzip rsync
          fc-cache -f || true

      - name: Build DOC00_TEMPLATE
        working-directory: PROJECT_L/DOCS/DOC00_TEMPLATE
        run: |
          set -euo pipefail
          # Prevent latexmk "missing .toc" fail on first pass in strict CI
          touch main.toc main.lof main.lot main.out main.aux
          latexmk -r ../../TOOLS/latexmkrc main.tex

      - name: QA (log sieve; fail-closed)
        working-directory: PROJECT_L
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from pathlib import Path
          import re, sys

          log_path = Path("DOCS/DOC00_TEMPLATE/main.log")
          pdf_path = Path("DOCS/DOC00_TEMPLATE/main.pdf")

          def tail(text: str, n=1200) -> str:
            return text[-n:] if len(text) > n else text

          if not pdf_path.exists():
            print("QA FAIL: PDF not produced:", pdf_path)
            if log_path.exists():
              txt = log_path.read_text(errors="replace")
              print("\n--- log tail ---\n", tail(txt), "\n--- end ---\n")
            sys.exit(1)

          txt = log_path.read_text(errors="replace") if log_path.exists() else ""

          # HARD FAIL patterns (real compile/quality killers)
          hard_patterns = [
            r"! LaTeX Error:",
            r"Emergency stop\.",
            r"Fatal error occurred, no output PDF file produced!",
            r"File `[^`]+?\.sty' not found",
            r"Package .* Error:",
            r"Missing character: There is no .*? in font",
            r"Font .*? not found",
          ]

          for pat in hard_patterns:
            if re.search(pat, txt):
              print(f"QA FAIL: hit pattern: {pat}")
              print("\n--- log tail ---\n", tail(txt), "\n--- end ---\n")
              sys.exit(1)

          # WARN-only patterns (layout warnings; do NOT fail CI)
          warn_patterns = [
            r"Overfull \\hbox",
            r"Underfull \\hbox",
          ]

          for pat in warn_patterns:
            if re.search(pat, txt):
              print(f"QA WARN: {pat} present")

          print("QA PASS")
          PY

      - name: Build SAFE bundle (PDF-only + SHA256)
        run: |
          set -euo pipefail
          rm -rf SAFE_PDF_BUNDLE
          mkdir -p SAFE_PDF_BUNDLE
          cp PROJECT_L/DOCS/DOC00_TEMPLATE/main.pdf SAFE_PDF_BUNDLE/DOC00_TEMPLATE_main.pdf
          (cd SAFE_PDF_BUNDLE && sha256sum *.pdf > SHA256SUMS.txt)

      - name: Upload SAFE artifact
        uses: actions/upload-artifact@v4
        with:
          name: SAFE_PDF_BUNDLE
          path: SAFE_PDF_BUNDLE

      - name: Make FULL CI ReleasePack (optional)
        if: ${{ always() }}
        run: |
          set -euo pipefail
          rm -rf FULL_RELEASEPACK_OPTIONAL
          mkdir -p FULL_RELEASEPACK_OPTIONAL/sahand-account-core
          rsync -a --exclude='.git' ./ FULL_RELEASEPACK_OPTIONAL/sahand-account-core/
          (cd FULL_RELEASEPACK_OPTIONAL && find . -type f -print0 | sort -z | xargs -0 sha256sum > SHA256SUMS.txt)
          (cd FULL_RELEASEPACK_OPTIONAL && zip -r FULL_RELEASEPACK_OPTIONAL.zip sahand-account-core SHA256SUMS.txt)

      - name: Upload FULL artifact (optional)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: FULL_RELEASEPACK_OPTIONAL
          path: FULL_RELEASEPACK_OPTIONAL/FULL_RELEASEPACK_OPTIONAL.zip
