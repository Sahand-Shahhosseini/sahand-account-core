name: Project-L Build + QA + ReleasePack

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install TeX + tools + fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y             texlive-luatex             texlive-latex-extra             texlive-fonts-recommended             texlive-fonts-extra             texlive-science             texlive-pictures             latexmk             zip             fonts-noto-core             fonts-noto-extra             fonts-stix || true

      - name: Build DOC00_TEMPLATE
        working-directory: PROJECT_L
        run: |
          latexmk -r TOOLS/latexmkrc -cd DOCS/DOC00_TEMPLATE/main.tex

      - name: QA (log sieve; fail-closed)
        working-directory: PROJECT_L
        run: |
          python3 - << 'PY'
          import sys
          from pathlib import Path

          log_path = Path("DOCS/DOC00_TEMPLATE/main.log")
          if not log_path.exists():
              print("QA FAIL: main.log not found (build did not produce log)")
              sys.exit(1)

          txt = log_path.read_text(encoding="utf-8", errors="ignore")

          # Fail-closed checks (deterministic, no regex escapes)
          issues = []

          if "Missing character:" in txt:
              issues.append("Missing character (tofu risk)")

          if "LaTeX Error:" in txt or "! LaTeX Error:" in txt:
              issues.append("LaTeX Error present in log")

          if "Fatal error occurred" in txt:
              issues.append("Fatal error occurred")

          # Not a hard-fail by default, but keep as warning bucket (you can make it hard later)
          overfull = ("Overfull \\hbox" in txt) or ("Underfull \\hbox" in txt)

          if issues:
              print("QA FAIL:", "; ".join(issues))
              lines = [
                  ln for ln in txt.splitlines()
                  if ("Missing character:" in ln) or ("LaTeX Error" in ln) or ("Fatal error" in ln)
              ]
              print("--- QA DEBUG (first 40 relevant lines) ---")
              for ln in lines[:40]:
                  print(ln)
              if overfull:
                  print("QA NOTE: Overfull/Underfull \\hbox warnings exist (not fail yet).")
              sys.exit(1)

          if overfull:
              print("QA PASS (with NOTE: Overfull/Underfull \\hbox warnings exist)")
          else:
              print("QA PASS")
          PY

      - name: Make CI ReleasePack zip
        working-directory: PROJECT_L
        run: |
          mkdir -p _release
          zip -r _release/RELEASEPACK_PROJECT_L_CI.zip             DOCS STYLEKIT TOOLS CONTRACT DB REGISTRY GOVERNANCE .gitignore || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: RELEASEPACK_PROJECT_L_CI
          path: PROJECT_L/_release/RELEASEPACK_PROJECT_L_CI.zip
